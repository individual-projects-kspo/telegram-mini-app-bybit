<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Main Account Earning</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { height: 100%; overflow-x: hidden; background: #111827; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
      body { -webkit-overflow-scrolling: touch; overscroll-behavior: none; }
      ::-webkit-scrollbar { display: none; }
      .header-safe { padding-top: max(1rem, env(safe-area-inset-top)); }
      .content-safe { padding: max(1rem, env(safe-area-inset-left)); padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
      .card { background: #374151; border: 1px solid #4b5563; }
      .stat-value { font-variant-numeric: tabular-nums; }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-full">
    <script>
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor("#111827");
        tg.MainButton.hide();
        tg.ready();
      }
    </script>
    <header class="bg-gray-900 border-b border-gray-700 header-safe sticky top-0 z-10">
      <div class="content-safe relative flex items-center py-6">
        <a href="index.html" class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg border border-gray-500 text-gray-300 hover:bg-gray-700 hover:border-gray-400 hover:text-white transition-colors z-10">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          <span>Geri</span>
        </a>
        <h1 class="absolute left-0 right-0 text-center text-lg font-semibold text-white pointer-events-none">Main Account Earning</h1>
      </div>
    </header>
    <main class="content-safe py-3 overflow-auto" id="main-content">
      <p class="text-gray-400 text-sm">Yükleniyor...</p>
    </main>
    <script>
      const API = "https://tracker.vinx.online/api/main/earnings";

      function escapeHtml(s) {
        const div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      async function load() {
        const el = document.getElementById("main-content");
        try {
          const res = await fetch(API);
          const data = await res.json();
          if (!data.success || !data.data) {
            el.innerHTML = '<p class="text-red-400 text-sm">Veri alınamadı.</p>';
            return;
          }
          const d = data.data;
          const summary = d.summary || {};
          const positions = d.positions || [];
          const totalStaked = summary.totalStaked || 1;
          const apy = ((summary.totalEarnings || 0) / totalStaked * 100).toFixed(2);
          const totalPnl = positions.reduce((s, p) => s + (p.totalPnl || 0), 0);
          const totalClaimable = positions.reduce((s, p) => s + (p.claimableYield || 0), 0);

          el.innerHTML = `
            <div class="space-y-3">
              <!-- Özet: tek satır 4 kutu -->
              <div class="grid grid-cols-2 gap-2">
                <div class="card rounded-lg p-3">
                  <p class="text-[10px] text-gray-400 uppercase tracking-wide">Earnings</p>
                  <p class="stat-value text-base font-bold text-green-400">$${Number(summary.totalEarnings).toLocaleString()}</p>
                </div>
                <div class="card rounded-lg p-3">
                  <p class="text-[10px] text-gray-400 uppercase tracking-wide">Staked</p>
                  <p class="stat-value text-base font-bold text-white">$${Number(summary.totalStaked).toLocaleString()}</p>
                </div>
                <div class="card rounded-lg p-3">
                  <p class="text-[10px] text-gray-400 uppercase tracking-wide">APY</p>
                  <p class="stat-value text-base font-bold text-blue-400">${apy}%</p>
                </div>
                <div class="card rounded-lg p-3">
                  <p class="text-[10px] text-gray-400 uppercase tracking-wide">Pozisyon</p>
                  <p class="stat-value text-base font-bold text-white">${summary.positionsCount ?? 0}</p>
                </div>
              </div>
              <!-- Toplam PnL & Claimable -->
              <div class="grid grid-cols-2 gap-2">
                <div class="card rounded-lg px-3 py-2 flex items-center justify-between">
                  <span class="text-xs text-gray-400">Toplam PnL</span>
                  <span class="stat-value text-sm font-semibold ${totalPnl >= 0 ? "text-green-400" : "text-red-400"}">${totalPnl >= 0 ? "+" : ""}$${Number(totalPnl).toLocaleString()}</span>
                </div>
                <div class="card rounded-lg px-3 py-2 flex items-center justify-between">
                  <span class="text-xs text-gray-400">Claimable</span>
                  <span class="stat-value text-sm font-semibold text-yellow-400">$${Number(totalClaimable).toLocaleString()}</span>
                </div>
              </div>
              <!-- Pozisyonlar: kompakt liste -->
              <div>
                <h3 class="text-xs text-gray-400 uppercase tracking-wide mb-1.5">Pozisyonlar (${positions.length})</h3>
                <div class="space-y-2">
                  ${positions.map(pos => {
                    const yieldPct = ((pos.earning || 0) / (pos.amount || 1) * 100).toFixed(2);
                    const pnlClass = (pos.totalPnl || 0) >= 0 ? "text-green-400" : "text-red-400";
                    return `
                    <div class="card rounded-lg p-2.5">
                      <div class="flex items-center justify-between gap-2 mb-1.5">
                        <div class="flex items-center gap-2 min-w-0">
                          <div class="w-7 h-7 bg-amber-600/80 rounded flex items-center justify-center flex-shrink-0"><span class="text-xs font-bold text-white">${escapeHtml((pos.coin || "").slice(0,2))}</span></div>
                          <div class="min-w-0">
                            <p class="font-medium text-white text-sm truncate">${escapeHtml(pos.coin)}</p>
                            <p class="text-[10px] text-gray-500">${Number(pos.amount).toLocaleString()} ${escapeHtml(pos.currency || "")}</p>
                          </div>
                        </div>
                        <span class="text-xs font-semibold ${pnlClass} whitespace-nowrap">${(pos.totalPnl || 0) >= 0 ? "+" : ""}$${Number(pos.totalPnl || 0).toLocaleString()}</span>
                      </div>
                      <div class="flex items-center justify-between text-[10px] text-gray-400 gap-2">
                        <span>Earning: <span class="text-green-400 font-medium">$${Number(pos.earning || 0).toLocaleString()}</span></span>
                        <span>Claimable: <span class="text-yellow-400 font-medium">$${Number(pos.claimableYield || 0).toLocaleString()}</span></span>
                        <span class="text-blue-400 font-medium">${yieldPct}%</span>
                      </div>
                    </div>`;
                  }).join("")}
                </div>
              </div>
            </div>`;
        } catch (e) {
          el.innerHTML = '<p class="text-red-400 text-sm">Bir hata oluştu.</p>';
          console.error(e);
        }
      }
      load();
    </script>
  </body>
</html>
