<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>Subaccount Stats</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
      html, body { height: 100%; overflow-x: hidden; background: #111827; padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
      body { -webkit-overflow-scrolling: touch; overscroll-behavior: none; }
      ::-webkit-scrollbar { display: none; }
      .header-safe { padding-top: calc(max(1rem, env(safe-area-inset-top)) * 0.25); }
      .content-safe { padding: max(1rem, env(safe-area-inset-left)); padding-bottom: max(1rem, env(safe-area-inset-bottom)); }
      /* Mobil: date input touch alanı */
      input[type="date"] { min-height: 44px; -webkit-appearance: none; appearance: none; }
    </style>
  </head>
  <body class="bg-gray-900 text-white min-h-full">
    <script>
      if (window.Telegram?.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.setHeaderColor("#111827");
        tg.MainButton.hide();
        tg.ready();
      }
    </script>
    <header class="bg-gray-900 border-b border-gray-700 header-safe">
      <div class="content-safe flex flex-col items-start gap-2 py-6">
        <a href="index.html" class="inline-flex items-center gap-1.5 px-3 py-2 rounded-lg border border-gray-500 text-gray-300 hover:bg-gray-700 hover:border-gray-400 hover:text-white transition-colors">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
          <span>Geri</span>
        </a>
        <h1 class="text-lg font-semibold text-white text-left">Subaccount Stats</h1>
      </div>
    </header>
    <main class="content-safe py-3 overflow-auto">
      <!-- Filtre: mobil uyumlu, dokunmatik hedefler -->
      <div class="bg-gray-800/80 border border-gray-600 rounded-xl p-3 mb-3">
        <div class="grid grid-cols-2 gap-2 mb-3">
          <div>
            <label for="stats-from" class="block text-xs text-gray-400 mb-1">Başlangıç</label>
            <input type="date" id="stats-from" class="w-full px-3 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
          </div>
          <div>
            <label for="stats-to" class="block text-xs text-gray-400 mb-1">Bitiş</label>
            <input type="date" id="stats-to" class="w-full px-3 py-2.5 bg-gray-700 border border-gray-600 rounded-lg text-white text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" />
          </div>
        </div>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <button type="button" id="stats-fetch" class="w-full py-3 bg-blue-600 hover:bg-blue-700 active:bg-blue-800 rounded-lg text-white font-medium text-sm touch-manipulation select-none">
            Verileri Getir
          </button>
          <a href="stats-graph.html" class="w-full py-3 bg-gray-600 hover:bg-gray-500 active:bg-gray-700 rounded-lg text-white font-medium text-sm touch-manipulation select-none flex items-center justify-center gap-1.5 border border-gray-500">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
            Grafik
          </a>
        </div>
        <div class="flex flex-wrap items-center gap-2 mt-2 text-xs">
          <span class="text-gray-400" id="stats-count">0 kayıt</span>
          <span class="text-gray-500">· Aralık en fazla 10 gün</span>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-sm">
          <thead class="bg-gray-700 sticky top-0" id="stats-thead"></thead>
          <tbody id="stats-tbody"></tbody>
        </table>
      </div>
    </main>
    <script>
      const API = "https://tracker.vinx.online/api/sub/summary/history";
      const MAX_RANGE_DAYS = 10;
      const STATS_COLUMNS = [
        { key: "created_at", label: "Tarih" },
        { key: "summary.totalEquity", label: "Total Equity" },
        { key: "summary.availableBalance", label: "Available Balance" },
        { key: "summary.unrealizedPnL", label: "Unrealized PnL" },
        { key: "summary.openPositionsCount", label: "Open Positions" },
        { key: "summary.totalPositionValue", label: "Total Position Value" },
        { key: "usdtBalance.walletBalance", label: "Realized Balance" },
      ];

      function escapeHtml(s) {
        const div = document.createElement("div");
        div.textContent = s;
        return div.innerHTML;
      }

      function getStatsValue(snap, key) {
        if (!snap) return "";
        if (key === "id") return snap.id;
        if (key === "created_at") return snap.created_at;
        if (key.startsWith("summary.")) return snap.summary?.[key.slice(8)];
        if (key.startsWith("usdtBalance.")) return snap.usdtBalance?.[key.slice(12)];
        return "";
      }

      function formatStatsCell(key, value) {
        if (value == null || value === "") return "";
        if (key === "created_at" && value) {
          try {
            const d = new Date(value);
            return isNaN(d.getTime()) ? String(value) : d.toLocaleString("tr-TR", { dateStyle: "short", timeStyle: "medium", timeZone: "Europe/Istanbul" });
          } catch (_) { return String(value); }
        }
        if (typeof value === "number" && Number.isFinite(value)) {
          if (key.includes("openPositionsCount")) {
            return Math.round(value).toLocaleString("tr-TR", { maximumFractionDigits: 0 });
          }
          return Number(value).toLocaleString("tr-TR", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }
        return String(value);
      }

      function renderHeader() {
        return STATS_COLUMNS.map(c => `<th class="text-left p-2 text-gray-300 text-xs whitespace-nowrap">${escapeHtml(c.label)}</th>`).join("");
      }

      function renderRows(snapshots) {
        if (!snapshots.length) return `<tr><td colspan="${STATS_COLUMNS.length}" class="p-4 text-gray-400 text-center">Kayıt yok</td></tr>`;
        return snapshots.map(snap => {
          const cells = STATS_COLUMNS.map(col => {
            const raw = getStatsValue(snap, col.key);
            const formatted = formatStatsCell(col.key, raw);
            const isPnl = col.key.includes("unrealizedPnL");
            const num = typeof raw === "number" ? raw : parseFloat(raw);
            const pnlClass = isPnl && !isNaN(num) ? (num >= 0 ? "text-green-400" : "text-red-400") : "text-white";
            return `<td class="p-2 ${pnlClass} text-xs whitespace-nowrap">${escapeHtml(formatted)}</td>`;
          }).join("");
          return `<tr class="hover:bg-gray-600 border-b border-gray-600">${cells}</tr>`;
        }).join("");
      }

      async function fetchAndRender(fromVal, toVal) {
        const thead = document.getElementById("stats-thead");
        const tbody = document.getElementById("stats-tbody");
        const countEl = document.getElementById("stats-count");
        const btn = document.getElementById("stats-fetch");
        if (!thead || !tbody || !countEl || !btn) return;
        function toZuluISO(dateStr) {
          const d = new Date(dateStr + "T00:00:00.000Z");
          return isNaN(d.getTime()) ? dateStr : d.toISOString();
        }
        function toZuluEndOfDay(dateStr) {
          const d = new Date(dateStr + "T23:59:59.999Z");
          return isNaN(d.getTime()) ? dateStr : d.toISOString();
        }
        let url = API;
        if (fromVal && toVal) {
          const fromDate = new Date(fromVal + "T00:00:00.000Z");
          const toDate = new Date(toVal + "T00:00:00.000Z");
          if (toDate - fromDate > MAX_RANGE_DAYS * 24 * 60 * 60 * 1000) {
            alert("Aralık en fazla " + MAX_RANGE_DAYS + " gün olabilir.");
            return;
          }
          url += "?from=" + encodeURIComponent(toZuluISO(fromVal)) + "&to=" + encodeURIComponent(toZuluEndOfDay(toVal));
        }
        btn.disabled = true;
        btn.textContent = "Yükleniyor...";
        try {
          const res = await fetch(url);
          const data = await res.json();
          if (!data.success) {
            alert(data.error || "Veri alınamadı");
            return;
          }
          const list = Array.isArray(data.data) ? data.data : [];
          thead.innerHTML = "<tr>" + renderHeader() + "</tr>";
          tbody.innerHTML = renderRows(list);
          countEl.textContent = (data.count ?? list.length) + " kayıt";
        } catch (e) {
          alert("İstek başarısız.");
        } finally {
          btn.disabled = false;
          btn.textContent = "Verileri Getir";
        }
      }

      const statsFetchEl = document.getElementById("stats-fetch");
      if (statsFetchEl) statsFetchEl.addEventListener("click", () => {
        const fromEl = document.getElementById("stats-from");
        const toEl = document.getElementById("stats-to");
        const fromVal = fromEl ? fromEl.value : "";
        const toVal = toEl ? toEl.value : "";
        if (fromVal && toVal) fetchAndRender(fromVal, toVal);
        else fetchAndRender(null, null);
      });

      function toLocalDateStr(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, "0");
        const day = String(d.getDate()).padStart(2, "0");
        return y + "-" + m + "-" + day;
      }
      const now = new Date();
      const fromDate = new Date(now.getTime() - MAX_RANGE_DAYS * 24 * 60 * 60 * 1000);
      const fromInput = document.getElementById("stats-from");
      const toInput = document.getElementById("stats-to");
      if (fromInput) fromInput.value = toLocalDateStr(fromDate);
      if (toInput) toInput.value = toLocalDateStr(now);
      fetchAndRender(null, null);
    </script>
  </body>
</html>
